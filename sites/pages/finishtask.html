<container>
    <div class="pt-main" style="background: #f6f8fa;">
        <div class="pt-main-row">
            <div class="pt-main-col">
                <div class="pt-panel">
                    <!-- 完结任务 -->
                    <div class="pt-title">
                        <h4>我的完结任务</h4>
                    </div>
                    <div id="myTaskDoneCount"></div>
                    <!-- 完结任务-end -->
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        taskDoneList = {
            showStyle: 'name',
            open: function (activityName, activityId, processId, formUrl) {
                if (formUrl.indexOf('/') != 0) {
                    formUrl = '/' + formUrl;
                }
                if (formUrl.indexOf(',') >= 0) {
                    var urls = formUrl.split(',');
                    if (urls.length == 3) {
                        formUrl = urls[2];
                    }
                    if (urls.length == 2) {//如果配置了两个url，则取第一个
                        formUrl = urls[0];
                    }
                }
                var url = formUrl + ';activityName=' + activityName + ";workflowType=2";
                if (activityId != "undefined" && processId != "undefined") {
                    url = url + ';processId=' + processId + ";activityId=" + activityId;
                }
                // nsFrame.loadPage(url);
                NetstarUI.labelpageVm.loadPage(url, activityName);
            },
            more: function () {
                nsalert('TODO: 显示更多（完整）任务', 'success');
            },
            initBlockList:function(domId,rows,showCount){
                var nameMap = {};
                var nameRows = [];
                for(var i = 0; i < rows.length; i++){
                    var row = rows[i];
                    var name = row.activityName;
                    if(!nameMap[name]){
                        nameMap[name] = {
                            activityName: name,
                            activityId: row.activityId,
                            processId: row.processId,
                            workitemCount: 0,
                            formUrl: row.formUrl,
                            processName:row.processName,
                            latestTime:row.latestTime,
                            rows: []
                        };
                        nameRows.push(nameMap[name]);
                    } else {
                        //有重复的activityName时
                        delete nameMap[name].activityId;
                        delete nameMap[name].processId;
                    }
                    if(!nameMap[name].formUrl && row.formUrl) {
                        nameMap[name].formUrl = row.formUrl;
                    }
                    nameMap[name].rows.push(row);
                    nameMap[name].workitemCount += row.workitemCount;
                }
               
                var homePageOffset = $('#netstar-main-page').offset();
                var gridHeight = $(window).outerHeight()-homePageOffset.top-48-10;
                var gridConfig = {
                    id:'myTaskDoneCount',
                    idField:'activityId',
                    plusClass:'card-task',
                    data:{
                        isSearch:false,
                        isPage:false,
                        isServerMode:false,
                        dataSource:nameRows,
                        primaryID:'activityId',
                    },
                    columns:[
                        {
                            field:'activityName',
                            title:'环节名称'
                        },{
                            field:'processName',
                            title:'所属流程'
                        },{
                            field:'latestTime',
                            title:'时间差',
                            formatHandler:{
                                type:'diffUnit'
                            }
                        }
                    ],
                    ui:{
                        pageLengthDefault:1000000000000,
                        display:'block',
                        isHaveEditDeleteBtn:false,
                        isHeader:false,
                        isPage:false,
                        isThead:false,
                        height:gridHeight,
                        selectMode:'single',
                        selectedHandler:function(data,$data,_vueData,_gridConfig){
                            taskDoneList.open(data.activityName,data.activityId,data.processId,data.formUrl);
                        },
                        listExpression:' <div class="card-task-top">'
                                            +'<div class="card-task-title"><a href="javascript:void(0);" title={{activityName}}>{{activityName}}</a></div>'
                                            +'<span class="card-task-number">{{workitemCount}}</span>'
                                        +'</div>'
                                        +'<div class="card-task-tag">'
                                            +'<span>{{processName}}</span>'
                                            +'<div class="card-task-time">{{latestTime}}</div>'
                                        +'</div>'
                    }
                };
                NetstarBlockList.init(gridConfig);
            },
            show: function (domId, showCount) {
                showCount = showCount || 50;
                nsEngine.getTaskDoneList(null, function (rows) {
                    if (rows != null) {
                        taskDoneList.initBlockList(domId,rows,showCount);
                        /*if ('name' == taskDoneList.showStyle) {
                            taskDoneList.showByName(domId, rows, showCount);
                        } else {
                            taskDoneList.showNormal(domId, rows, showCount);
                        }*/
                    }
                }, function (msg) {
                    nsalert(msg, 'error');
                });
            },
            showNormal: function (domId, rows, showCount) {
                var str = '<ul style="list-style-type: decimal" >';
                var i;
                var index = rows.length < showCount ? rows.length : showCount;
                for (i = 0; i < index; i++) {
                    str = str
                        + '<li style="font-size: 12px;">'
                        + '<a style="font-size: 12px;text-decoration:none;color:#666666" href="javascript:taskDoneList.open(\''
                        + rows[i].activityName + '\',\''
                        + rows[i].activityId + '\',\''
                        + rows[i].processId + '\',\''
                        + rows[i].formUrl + '\')">'
                        + rows[i].processName;
                    str = str
                        + '->'
                        + rows[i].activityName
                        + '(' + rows[i].workitemCount + ')'
                        + '</a></li>';
                }
                if (rows.length > showCount) {
                    str = str
                        + '<span style="float:right;"><a style="font-size: 12px;text-decoration:none;color:#666666" href="javascript:taskDoneList.more()">更多...</a><span>';
                }
                str = str + "</ul>";
                $(domId).empty();
                $(domId).append(str);
            },
            showByName: function (domId, rows, showCount) {
                //处理数据，改为按照环节名称进行分组
                var nameMap = {};
                var nameRows = [];
                for (var i = 0; i < rows.length; i++) {
                    var row = rows[i];
                    var name = row.activityName;
                    if (!nameMap[name]) {
                        nameMap[name] = {
                            activityName: name,
                            activityId: row.activityId,
                            processId: row.processId,
                            workitemCount: 0,
                            formUrl: row.formUrl,
                            rows: []
                        };
                        nameRows.push(nameMap[name]);
                    } else {
                        //有重复的activityName时
                        delete nameMap[name].activityId;
                        delete nameMap[name].processId;
                    }
                    if (!nameMap[name].formUrl && row.formUrl) {
                        nameMap[name].formUrl = row.formUrl;
                    }
                    nameMap[name].rows.push(row);
                    nameMap[name].workitemCount += row.workitemCount;
                }

                var str = '<ul style="list-style-type: decimal" >';
                var i;
                var index = nameRows.length < showCount ? nameRows.length : showCount;
                for (i = 0; i < index; i++) {
                    str = str
                        + '<li style="font-size: 12px;">'
                        + '<a style="font-size: 12px;text-decoration:none;color:#666666" href="javascript:taskDoneList.open(\''
                        + nameRows[i].activityName + '\',\''
                        + nameRows[i].activityId + '\',\''
                        + nameRows[i].processId + '\',\''
                        + nameRows[i].formUrl + '\')">'
                        + nameRows[i].activityName
                        + ' ( ' + nameRows[i].workitemCount + ' ) '
                        + '</a></li>';
                }
                if (rows.length > showCount) {
                    str = str
                        + '<span style="float:right;"><a style="font-size: 12px;text-decoration:none;color:#666666" href="javascript:taskDoneList.more()">更多...</a><span>';
                }
                str = str + "</ul>";
                $(domId).empty();
                $(domId).append(str);
            },
        };
        $(function () {
            taskDoneList.show('#myTaskDoneCount');
        });
    </script>
</container>
